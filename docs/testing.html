
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_CN">
  <head>
    <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>测试Flask应用程序 &#8212; Flask Documentation (1.1.x)</title>
    <link rel="stylesheet" href="_static/flask.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="shortcut icon" href="_static/flask-icon.png"/>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="应用程序错误" href="errorhandling.html" />
    <link rel="prev" title="模板" href="templating.html" />
  <script>DOCUMENTATION_OPTIONS.URL_ROOT = './';</script>
   
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="errorhandling.html" title="应用程序错误"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="templating.html" title="模板"
             accesskey="P">上一页</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Flask Documentation (1.1.x)</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="testing-flask-applications">
<span id="testing"></span><h1>测试Flask应用程序<a class="headerlink" href="#testing-flask-applications" title="永久链接至标题">¶</a></h1>
<blockquote>
<div><p><strong>未经测试的东西被打破了.</strong></p>
</div></blockquote>
<p>The origin of this quote is unknown and while it is not entirely correct, it
is also not far from the truth.  Untested applications make it hard to
improve existing code and developers of untested applications tend to
become pretty paranoid.  If an application has automated tests, you can
safely make changes and instantly know if anything breaks.</p>
<p>Flask provides a way to test your application by exposing the Werkzeug
test <a class="reference external" href="https://werkzeug.palletsprojects.com/en/0.15.x/test/#werkzeug.test.Client" title="(在 Werkzeug v0.15.x)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Client</span></code></a> and handling the context locals for you.
You can then use that with your favourite testing solution.</p>
<p>在本文档中，我们将使用`pytest`_包作为测试的基础框架. 您可以使用``pip``安装它，就像这样:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install pytest
</pre></div>
</div>
<div class="section" id="the-application">
<h2>应用程序<a class="headerlink" href="#the-application" title="永久链接至标题">¶</a></h2>
<p>First, we need an application to test; we will use the application from
the <a class="reference internal" href="tutorial/index.html#tutorial"><span class="std std-ref">教程</span></a>.  If you don’t have that application yet, get the
source code from <a class="reference external" href="https://github.com/pallets/flask/tree/1.1.dev0/examples/tutorial">the examples</a>.</p>
</div>
<div class="section" id="the-testing-skeleton">
<h2>测试骨架<a class="headerlink" href="#the-testing-skeleton" title="永久链接至标题">¶</a></h2>
<p>We begin by adding a tests directory under the application root.  Then
create a Python file to store our tests (<code class="file docutils literal notranslate"><span class="pre">test_flaskr.py</span></code>). When we
format the filename like <code class="docutils literal notranslate"><span class="pre">test_*.py</span></code>, it will be auto-discoverable by
pytest.</p>
<p>接下来，我们创建一个`pytest fixture``，名为:func:<cite>client</cite>，用于配置应用程序以进行测试并初始化新数据库:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">flaskr</span> <span class="k">import</span> <span class="n">flaskr</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">client</span><span class="p">():</span>
    <span class="n">db_fd</span><span class="p">,</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DATABASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
    <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;TESTING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="n">flaskr</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">client</span>

    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">db_fd</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DATABASE&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>This client fixture will be called by each individual test.  It gives us a
simple interface to the application, where we can trigger test requests to the
application.  The client will also keep track of cookies for us.</p>
<p>During setup, the <code class="docutils literal notranslate"><span class="pre">TESTING</span></code> config flag is activated.  What
this does is disable error catching during request handling, so that
you get better error reports when performing test requests against the
application.</p>
<p>Because SQLite3 is filesystem-based, we can easily use the <a class="reference external" href="https://docs.python.org/3/library/tempfile.html#module-tempfile" title="(在 Python v3.7)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tempfile</span></code></a> module
to create a temporary database and initialize it.  The
<a class="reference external" href="https://docs.python.org/3/library/tempfile.html#tempfile.mkstemp" title="(在 Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">mkstemp()</span></code></a> function does two things for us: it returns a
low-level file handle and a random file name, the latter we use as
database name.  We just have to keep the <cite>db_fd</cite> around so that we can use
the <a class="reference external" href="https://docs.python.org/3/library/os.html#os.close" title="(在 Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">os.close()</span></code></a> function to close the file.</p>
<p>要在测试后删除数据库，fixture会关闭文件并将其从文件系统中删除.</p>
<p>如果我们现在运行测试套件，我们应该看到以下输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pytest

================ test session starts ================
rootdir: ./flask/examples/flaskr, inifile: setup.cfg
collected 0 items

=========== no tests ran in 0.07 seconds ============
</pre></div>
</div>
<p>Even though it did not run any actual tests, we already know that our <code class="docutils literal notranslate"><span class="pre">flaskr</span></code>
application is syntactically valid, otherwise the import would have died
with an exception.</p>
</div>
<div class="section" id="the-first-test">
<h2>第一次测试<a class="headerlink" href="#the-first-test" title="永久链接至标题">¶</a></h2>
<p>Now it’s time to start testing the functionality of the application.
Let’s check that the application shows “No entries here so far” if we
access the root of the application (<code class="docutils literal notranslate"><span class="pre">/</span></code>).  To do this, we add a new
test function to <code class="file docutils literal notranslate"><span class="pre">test_flaskr.py</span></code>, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_empty_db</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Start with a blank database.&quot;&quot;&quot;</span>

    <span class="n">rv</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="sa">b</span><span class="s1">&#39;No entries here so far&#39;</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<p>请注意，我们的测试函数以“test”开头;这允许`pytest`_自动将该函数识别为要运行的测试.</p>
<p>By using <code class="docutils literal notranslate"><span class="pre">client.get</span></code> we can send an HTTP <code class="docutils literal notranslate"><span class="pre">GET</span></code> request to the application with
the given path.  The return value will be a <a class="reference internal" href="api.html#flask.Flask.response_class" title="flask.Flask.response_class"><code class="xref py py-class docutils literal notranslate"><span class="pre">response_class</span></code></a> object.
We can now use the <a class="reference external" href="https://werkzeug.palletsprojects.com/en/0.15.x/wrappers/#werkzeug.wrappers.BaseResponse.data" title="(在 Werkzeug v0.15.x)"><code class="xref py py-attr docutils literal notranslate"><span class="pre">data</span></code></a> attribute to inspect
the return value (as string) from the application.  In this case, we ensure that
<code class="docutils literal notranslate"><span class="pre">'No</span> <span class="pre">entries</span> <span class="pre">here</span> <span class="pre">so</span> <span class="pre">far'</span></code> is part of the output.</p>
<p>再次运行它，你应该看到一个通过测试:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pytest -v

================ test session starts ================
rootdir: ./flask/examples/flaskr, inifile: setup.cfg
collected 1 items

tests/test_flaskr.py::test_empty_db PASSED

============= 1 passed in 0.10 seconds ==============
</pre></div>
</div>
</div>
<div class="section" id="logging-in-and-out">
<h2>登录和注销<a class="headerlink" href="#logging-in-and-out" title="永久链接至标题">¶</a></h2>
<p>The majority of the functionality of our application is only available for
the administrative user, so we need a way to log our test client in and out
of the application.  To do this, we fire some requests to the login and logout
pages with the required form data (username and password).  And because the
login and logout pages redirect, we tell the client to <cite>follow_redirects</cite>.</p>
<p>将以下两个函数添加到:file:<a href="#id1"><span class="problematic" id="id2">`</span></a>test_flaskr.py`文件中:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">password</span>
    <span class="p">),</span> <span class="n">follow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">,</span> <span class="n">follow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>现在，我们可以轻松地测试登录和注销是否正常工作，以及它是否因无效凭据而失败. 添加这个新的测试功能:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_login_logout</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make sure login and logout works.&quot;&quot;&quot;</span>

    <span class="n">rv</span> <span class="o">=</span> <span class="n">login</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;USERNAME&#39;</span><span class="p">],</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PASSWORD&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="sa">b</span><span class="s1">&#39;You were logged in&#39;</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>

    <span class="n">rv</span> <span class="o">=</span> <span class="n">logout</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
    <span class="k">assert</span> <span class="sa">b</span><span class="s1">&#39;You were logged out&#39;</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>

    <span class="n">rv</span> <span class="o">=</span> <span class="n">login</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;USERNAME&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PASSWORD&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="sa">b</span><span class="s1">&#39;Invalid username&#39;</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>

    <span class="n">rv</span> <span class="o">=</span> <span class="n">login</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;USERNAME&#39;</span><span class="p">],</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PASSWORD&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="sa">b</span><span class="s1">&#39;Invalid password&#39;</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="section" id="test-adding-messages">
<h2>测试添加消息<a class="headerlink" href="#test-adding-messages" title="永久链接至标题">¶</a></h2>
<p>我们还应该测试添加消息是否有效. 像这样添加一个新的测试函数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_messages</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test that messages work.&quot;&quot;&quot;</span>

    <span class="n">login</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;USERNAME&#39;</span><span class="p">],</span> <span class="n">flaskr</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PASSWORD&#39;</span><span class="p">])</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/add&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&lt;Hello&gt;&#39;</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="s1">&#39;&lt;strong&gt;HTML&lt;/strong&gt; allowed here&#39;</span>
    <span class="p">),</span> <span class="n">follow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="sa">b</span><span class="s1">&#39;No entries here so far&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>
    <span class="k">assert</span> <span class="sa">b</span><span class="s1">&#39;&amp;lt;Hello&amp;gt;&#39;</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>
    <span class="k">assert</span> <span class="sa">b</span><span class="s1">&#39;&lt;strong&gt;HTML&lt;/strong&gt; allowed here&#39;</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<p>在这里，我们检查文本中是否允许HTML，而不是标题中的HTML，这是预期的行为.</p>
<p>运行它现在应该给我们三个通过测试:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pytest -v

================ test session starts ================
rootdir: ./flask/examples/flaskr, inifile: setup.cfg
collected 3 items

tests/test_flaskr.py::test_empty_db PASSED
tests/test_flaskr.py::test_login_logout PASSED
tests/test_flaskr.py::test_messages PASSED

============= 3 passed in 0.23 seconds ==============
</pre></div>
</div>
</div>
<div class="section" id="other-testing-tricks">
<h2>其他测试技巧<a class="headerlink" href="#other-testing-tricks" title="永久链接至标题">¶</a></h2>
<p>Besides using the test client as shown above, there is also the
<a class="reference internal" href="api.html#flask.Flask.test_request_context" title="flask.Flask.test_request_context"><code class="xref py py-meth docutils literal notranslate"><span class="pre">test_request_context()</span></code></a> method that can be used
in combination with the <code class="docutils literal notranslate"><span class="pre">with</span></code> statement to activate a request context
temporarily.  With this you can access the <a class="reference internal" href="api.html#flask.request" title="flask.request"><code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code></a>,
<a class="reference internal" href="api.html#flask.g" title="flask.g"><code class="xref py py-class docutils literal notranslate"><span class="pre">g</span></code></a> and <a class="reference internal" href="api.html#flask.session" title="flask.session"><code class="xref py py-class docutils literal notranslate"><span class="pre">session</span></code></a> objects like in view
functions.  Here is a full example that demonstrates this approach:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s1">&#39;/?name=Peter&#39;</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">assert</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Peter&#39;</span>
</pre></div>
</div>
<p>可以以相同的方式使用上下文绑定的所有其他对象.</p>
<p>If you want to test your application with different configurations and
there does not seem to be a good way to do that, consider switching to
application factories (see <a class="reference internal" href="patterns/appfactories.html#app-factories"><span class="std std-ref">应用工厂</span></a>).</p>
<p>Note however that if you are using a test request context, the
<a class="reference internal" href="api.html#flask.Flask.before_request" title="flask.Flask.before_request"><code class="xref py py-meth docutils literal notranslate"><span class="pre">before_request()</span></code></a> and <a class="reference internal" href="api.html#flask.Flask.after_request" title="flask.Flask.after_request"><code class="xref py py-meth docutils literal notranslate"><span class="pre">after_request()</span></code></a>
functions are not called automatically.  However
<a class="reference internal" href="api.html#flask.Flask.teardown_request" title="flask.Flask.teardown_request"><code class="xref py py-meth docutils literal notranslate"><span class="pre">teardown_request()</span></code></a> functions are indeed executed when
the test request context leaves the <code class="docutils literal notranslate"><span class="pre">with</span></code> block.  If you do want the
<a class="reference internal" href="api.html#flask.Flask.before_request" title="flask.Flask.before_request"><code class="xref py py-meth docutils literal notranslate"><span class="pre">before_request()</span></code></a> functions to be called as well, you
need to call <a class="reference internal" href="api.html#flask.Flask.preprocess_request" title="flask.Flask.preprocess_request"><code class="xref py py-meth docutils literal notranslate"><span class="pre">preprocess_request()</span></code></a> yourself:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s1">&#39;/?name=Peter&#39;</span><span class="p">):</span>
    <span class="n">app</span><span class="o">.</span><span class="n">preprocess_request</span><span class="p">()</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>根据应用程序的设计方式，这可能是打开数据库连接或类似连接所必需的.</p>
<p>If you want to call the <a class="reference internal" href="api.html#flask.Flask.after_request" title="flask.Flask.after_request"><code class="xref py py-meth docutils literal notranslate"><span class="pre">after_request()</span></code></a> functions you
need to call into <a class="reference internal" href="api.html#flask.Flask.process_response" title="flask.Flask.process_response"><code class="xref py py-meth docutils literal notranslate"><span class="pre">process_response()</span></code></a> which however
requires that you pass it a response object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s1">&#39;/?name=Peter&#39;</span><span class="p">):</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This in general is less useful because at that point you can directly
start using the test client.</p>
</div>
<div class="section" id="faking-resources-and-context">
<span id="faking-resources"></span><h2>伪造资源和背景<a class="headerlink" href="#faking-resources-and-context" title="永久链接至标题">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">0.10 新版功能.</span></p>
</div>
<details class="changelog">
<summary>Changelog</summary></details><p>A very common pattern is to store user authorization information and
database connections on the application context or the <a class="reference internal" href="api.html#flask.g" title="flask.g"><code class="xref py py-attr docutils literal notranslate"><span class="pre">flask.g</span></code></a>
object.  The general pattern for this is to put the object on there on
first usage and then to remove it on a teardown.  Imagine for instance
this code to get the current user:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_user</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">fetch_current_user_from_database</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="k">return</span> <span class="n">user</span>
</pre></div>
</div>
<p>For a test it would be nice to override this user from the outside without
having to change some code.  This can be accomplished with
hooking the <a class="reference internal" href="api.html#flask.appcontext_pushed" title="flask.appcontext_pushed"><code class="xref py py-data docutils literal notranslate"><span class="pre">flask.appcontext_pushed</span></code></a> signal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">appcontext_pushed</span><span class="p">,</span> <span class="n">g</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">user_set</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">g</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="k">with</span> <span class="n">appcontext_pushed</span><span class="o">.</span><span class="n">connected_to</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="k">yield</span>
</pre></div>
</div>
<p>然后使用它:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">json</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users/me&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">users_me</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

<span class="k">with</span> <span class="n">user_set</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">my_user</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/users/me&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_equal</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">my_user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="keeping-the-context-around">
<h2>保持环境<a class="headerlink" href="#keeping-the-context-around" title="永久链接至标题">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">0.4 新版功能.</span></p>
</div>
<details class="changelog">
<summary>Changelog</summary></details><p>Sometimes it is helpful to trigger a regular request but still keep the
context around for a little longer so that additional introspection can
happen.  With Flask 0.4 this is possible by using the
<a class="reference internal" href="api.html#flask.Flask.test_client" title="flask.Flask.test_client"><code class="xref py py-meth docutils literal notranslate"><span class="pre">test_client()</span></code></a> with a <code class="docutils literal notranslate"><span class="pre">with</span></code> block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/?tequila=42&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;tequila&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;42&#39;</span>
</pre></div>
</div>
<p>If you were to use just the <a class="reference internal" href="api.html#flask.Flask.test_client" title="flask.Flask.test_client"><code class="xref py py-meth docutils literal notranslate"><span class="pre">test_client()</span></code></a> without
the <code class="docutils literal notranslate"><span class="pre">with</span></code> block, the <code class="docutils literal notranslate"><span class="pre">assert</span></code> would fail with an error because <cite>request</cite>
is no longer available (because you are trying to use it outside of the actual request).</p>
</div>
<div class="section" id="accessing-and-modifying-sessions">
<h2>访问和修改会话<a class="headerlink" href="#accessing-and-modifying-sessions" title="永久链接至标题">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">0.8 新版功能.</span></p>
</div>
<details class="changelog">
<summary>Changelog</summary></details><p>Sometimes it can be very helpful to access or modify the sessions from the
test client.  Generally there are two ways for this.  If you just want to
ensure that a session has certain keys set to certain values you can just
keep the context around and access <a class="reference internal" href="api.html#flask.session" title="flask.session"><code class="xref py py-data docutils literal notranslate"><span class="pre">flask.session</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">flask</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">42</span>
</pre></div>
</div>
<p>This however does not make it possible to also modify the session or to
access the session before a request was fired.  Starting with Flask 0.8 we
provide a so called “session transaction” which simulates the appropriate
calls to open a session in the context of the test client and to modify
it.  At the end of the transaction the session is stored.  This works
independently of the session backend used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">c</span><span class="o">.</span><span class="n">session_transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">sess</span><span class="p">[</span><span class="s1">&#39;a_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;a value&#39;</span>

    <span class="c1"># once this is reached the session was stored</span>
</pre></div>
</div>
<p>Note that in this case you have to use the <code class="docutils literal notranslate"><span class="pre">sess</span></code> object instead of the
<a class="reference internal" href="api.html#flask.session" title="flask.session"><code class="xref py py-data docutils literal notranslate"><span class="pre">flask.session</span></code></a> proxy.  The object however itself will provide the
same interface.</p>
</div>
<div class="section" id="testing-json-apis">
<h2>测试JSON API<a class="headerlink" href="#testing-json-apis" title="永久链接至标题">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">1.0 新版功能.</span></p>
</div>
<details class="changelog">
<summary>Changelog</summary></details><p>Flask has great support for JSON, and is a popular choice for building JSON
APIs. Making requests with JSON data and examining JSON data in responses is
very convenient:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/auth&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">auth</span><span class="p">():</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">generate_token</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>

<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/api/auth&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;flask@example.com&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;secret&#39;</span>
    <span class="p">})</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">verify_token</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Passing the <code class="docutils literal notranslate"><span class="pre">json</span></code> argument in the test client methods sets the request data
to the JSON-serialized object and sets the content type to
<code class="docutils literal notranslate"><span class="pre">application/json</span></code>. You can get the JSON data from the request or response
with <code class="docutils literal notranslate"><span class="pre">get_json</span></code>.</p>
</div>
<div class="section" id="testing-cli-commands">
<span id="testing-cli"></span><h2>测试CLI命令<a class="headerlink" href="#testing-cli-commands" title="永久链接至标题">¶</a></h2>
<p>Click comes with <a class="reference external" href="http://click.pocoo.org/testing">utilities for testing</a> your CLI commands. A
<a class="reference external" href="https://click.palletsprojects.com/en/7.x/api/#click.testing.CliRunner" title="(在 Click v7.x)"><code class="xref py py-class docutils literal notranslate"><span class="pre">CliRunner</span></code></a> runs commands in isolation and
captures the output in a <a class="reference external" href="https://click.palletsprojects.com/en/7.x/api/#click.testing.Result" title="(在 Click v7.x)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> object.</p>
<p>Flask provides <a class="reference internal" href="api.html#flask.Flask.test_cli_runner" title="flask.Flask.test_cli_runner"><code class="xref py py-meth docutils literal notranslate"><span class="pre">test_cli_runner()</span></code></a> to create a
<a class="reference internal" href="api.html#flask.testing.FlaskCliRunner" title="flask.testing.FlaskCliRunner"><code class="xref py py-class docutils literal notranslate"><span class="pre">FlaskCliRunner</span></code></a> that passes the Flask app to the
CLI automatically. Use its <a class="reference internal" href="api.html#flask.testing.FlaskCliRunner.invoke" title="flask.testing.FlaskCliRunner.invoke"><code class="xref py py-meth docutils literal notranslate"><span class="pre">invoke()</span></code></a>
method to call commands in the same way they would be called from the
command line.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">click</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--name&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;World&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Hello, </span><span class="si">{name}</span><span class="s1">!&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_hello</span><span class="p">():</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">test_cli_runner</span><span class="p">()</span>

    <span class="c1"># invoke the command directly</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">hello_command</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;--name&#39;</span><span class="p">,</span> <span class="s1">&#39;Flask&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="s1">&#39;Hello, Flask&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">output</span>

    <span class="c1"># or by name</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="s1">&#39;World&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">output</span>
</pre></div>
</div>
<p>在上面的示例中，按名称调用命令很有用，因为它验证命令是否已正确注册到应用程序.</p>
<p>If you want to test how your command parses parameters, without running
the command, use its <a class="reference external" href="https://click.palletsprojects.com/en/7.x/api/#click.BaseCommand.make_context" title="(在 Click v7.x)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">make_context()</span></code></a> method.
This is useful for testing complex validation rules and custom types.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">upper</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--name&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;World&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">upper</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Hello, </span><span class="si">{name}</span><span class="s1">!&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_hello_params</span><span class="p">():</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">hello_command</span><span class="o">.</span><span class="n">make_context</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;--name&#39;</span><span class="p">,</span> <span class="s1">&#39;flask&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">context</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FLASK&#39;</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
  <span id="sidebar-top"></span>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  
    
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/flask-logo-sidebar.png" alt="Logo"/>
            </a></p>
  

  <h3>Contents</h3>
  <ul>
<li><a class="reference internal" href="#">测试Flask应用程序</a><ul>
<li><a class="reference internal" href="#the-application">应用程序</a></li>
<li><a class="reference internal" href="#the-testing-skeleton">测试骨架</a></li>
<li><a class="reference internal" href="#the-first-test">第一次测试</a></li>
<li><a class="reference internal" href="#logging-in-and-out">登录和注销</a></li>
<li><a class="reference internal" href="#test-adding-messages">测试添加消息</a></li>
<li><a class="reference internal" href="#other-testing-tricks">其他测试技巧</a></li>
<li><a class="reference internal" href="#faking-resources-and-context">伪造资源和背景</a></li>
<li><a class="reference internal" href="#keeping-the-context-around">保持环境</a></li>
<li><a class="reference internal" href="#accessing-and-modifying-sessions">访问和修改会话</a></li>
<li><a class="reference internal" href="#testing-json-apis">测试JSON API</a></li>
<li><a class="reference internal" href="#testing-cli-commands">测试CLI命令</a></li>
</ul>
</li>
</ul>
<h3>Navigation</h3>
<ul>
  <li><a href="index.html">Overview</a>
    <ul>
          <li>Previous: <a href="templating.html" title="上一章">模板</a>
          <li>Next: <a href="errorhandling.html" title="下一章">应用程序错误</a>
    </ul>
  </li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="footer" role="contentinfo">
        &#169; 版权所有 2010 Pallets Team.
      由 <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.0+/31d45d9d 创建。
    </div>

  </body>
</html>